# ---
# Step 2: Decision Point & Condition Wait Segments
# ---
#
# Build segments for decision point branches and condition waits.
# Criteria segments (goal, entry, exit, milestone) are already done in Step 1.
#
# --- Choosing between decision_point and condition wait ---
#
#   Use duration wait + decision_point when:
#     "Wait 5 days, THEN check if the user logged in"
#     → Fixed delay, then segment-based branching
#
#   Use condition wait (with timeout) when:
#     "Wait UP TO 5 days for the user to log in, react immediately if they do"
#     → Respond as soon as the condition is met, with a timeout fallback
#
#   If unsure, ask the client: "Should we react immediately when the user
#   takes the action, or wait a fixed period and then check?"
#
# NOTE: Only use segments defined in YOUR segments: section.
# ref: only works with journey-type segments from other journeys.
#
# --- REQUIRED: Plan the stage flows first (do NOT skip) ---
# Before writing segments, you must understand what decisions and waits
# each stage needs. For each stage, ask the client:
#
#   1. What decision points exist? (e.g., "Did user open email?",
#      "What is the user's engagement level?")
#   2. For each decision point, what are the branches?
#      - Which branches need a NEW segment?
#      - Which branches reuse an existing segment from Step 1?
#      - Which branch is the "excluded" catch-all (no segment needed)?
#   3. Are there any condition-based waits?
#      (e.g., "Wait until user makes a purchase, up to 7 days")
#      Duration waits (e.g., "Wait 3 days") do NOT need segments.
#
# --- Discovery (if not already done in Step 1) ---
# Use the same discovery commands as Step 1 to verify attribute names:
#      tdx sg fields
#      tdx query "SELECT column, COUNT(*) FROM table GROUP BY 1 ORDER BY 2 DESC LIMIT 20"
#
# --- Checklist ---
# For EVERY decision point, ensure ALL non-excluded branches have a segment.
# For EVERY condition wait, ensure the trigger condition has a segment.
# Missing even one segment will cause errors in later steps.
#
# --- If segment rules aren't working ---
# Load the **segment** skill for full operator reference, Behavior conditions,
# filter/timeWindow syntax, and nested condition groups.
#
# --- After designing the segments ---
#   1. Add the new segments to the segments: section with "# NEW" comments
#   2. Add a structure summary at the bottom as comments
#   3. Show the segment design to the client and get confirmation
#   4. Once confirmed, write the updated YAML and immediately move to Step 3.
#      Do NOT ask "shall we proceed?" — confirmation was already given.
#
# ---

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

segments:
  # (criteria segments from Step 1 — do not modify)

  # -- Stage 1: Welcome & Engagement --
  # decision_point: Email Open Check
  # - "Opened" branch (reuses: email_engaged from Step 1)
  # - "Not Opened" branch (excluded — no segment needed)
  #
  # wait steps: duration only (no segments needed)

  # -- Stage 2: Product Activation --
  # decision_point: Usage Level Check
  power_users:                                                 # NEW
    description: Users with 10+ logins and 5+ features used
    rule:
      type: And
      conditions:
        - type: Value
          attribute: login_count_7d
          operator:
            type: GreaterEqual
            value: 10
        - type: Value
          attribute: feature_usage_count
          operator:
            type: GreaterEqual
            value: 5
  # - "Active" branch (reuses: active_users from Step 1)
  # - "Inactive" branch (excluded — no segment needed)
  #
  # wait steps: duration only (no segments needed)

  # -- Stage 3: Retention & Loyalty --
  # decision_point: NPS Score Check
  nps_promoters:                                               # NEW
    description: NPS score 9 or above
    rule:
      type: And
      conditions:
        - type: Value
          attribute: nps_score
          operator:
            type: GreaterEqual
            value: 9
  nps_detractors:                                              # NEW
    description: NPS score 6 or below
    rule:
      type: And
      conditions:
        - type: Value
          attribute: nps_score
          operator:
            type: LessEqual
            value: 6
  # - "Passive" branch (excluded — no segment needed)
  #
  # wait steps: duration only (no segments needed)

  # --- Example: Condition wait segment ---
  # If a stage needs a condition-based wait (e.g., "wait until purchase"):
  #
  # made_purchase:                                             # NEW (wait_condition)
  #   description: User completed a purchase
  #   rule:
  #     type: And
  #     conditions:
  #       - type: Behavior
  #         attribute: purchase_event
  #         operator:
  #           type: GreaterEqual
  #           value: 1
  #         aggregation:
  #           type: Count
  #         source: behavior_purchases

# Stage flows: S1=EmailOpen(Opened/NotOpened) S2=Usage(Power/Active/Inactive) S3=NPS(Promoter/Detractor/Passive)
