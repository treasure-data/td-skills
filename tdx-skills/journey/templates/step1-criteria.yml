# ---
# Step 1: Criteria Segments
# ---
#
# Build segments for journey criteria ONLY:
#   - Goal segment
#   - Stage entry_criteria
#   - Stage milestones
#   - Stage exit_criteria
#
# Decision point branches and condition waits come in Step 2.
#
# ---
# *** STOP — Discovery & Data Analysis FIRST (do NOT skip) ***
# ---
#
# You MUST run these commands and analyze real data BEFORE writing any segments.
# Do NOT propose segment rules based on guesses or assumptions.
#
# 1. Get the output table name:
#      tdx ps desc -o
#
# 2. Discover available attributes and behaviors:
#      tdx sg fields
#
# 3. Analyze actual data values to determine rule thresholds:
#      tdx query "SELECT column, COUNT(*) FROM table GROUP BY 1 ORDER BY 2 DESC LIMIT 20"
#
#    Column names alone are NOT enough to write rules.
#    You MUST query actual data to understand:
#      - What values exist (e.g., status column: "active", "churned", "pending"?)
#      - Value distributions (e.g., avg purchase amount, login count ranges)
#      - Behavior table names and their row counts
#
# Do NOT proceed to writing segments until you have run discovery commands
# and confirmed real attribute names and threshold values with actual data.
#
# --- Segment Strategy ---
#
# Always create embedded segments for journey criteria.
# Use `tdx sg fields` output to build rules.
# Define segments inline in the segments: section.
#
# NOTE on ref: — ref: can ONLY reference journey-type segments (kind=3)
# created by other journeys. It does NOT work with regular child segments
# from `tdx sg list`. When reusing logic from existing segments, pull the
# other journey (`tdx journey pull`) and copy the segment rules into your
# new journey's embedded segments.
#
# ---
# CRITERIA RULES (CRITICAL — understand before writing segments)
# ---
#
# 1. Goal: Journey-level success condition. One segment required.
#
# 2. entry_criteria: Stage 1 requires a NEW segment for entry_criteria.
#    Stage 2+ entry_criteria in the YAML references the PREVIOUS stage's
#    milestone segment. Do NOT create new segments for Stage 2+ entry.
#    (The YAML field is still written, but it reuses the milestone segment.)
#
# 3. milestone: Defines WHO MOVES TO THE NEXT STAGE (not this stage's goal).
#    Think of it as the "graduation criteria" for entering the next stage.
#    - Stage 1 milestone → used as Stage 2 entry_criteria
#    - Stage 2 milestone → used as Stage 3 entry_criteria
#    - Last stage: NO milestone (no next stage)
#    TIP: Include "— ready for Stage N" in the segment description
#    to clarify the purpose (e.g., "Users who opened email — ready for Stage 2")
#
# 4. exit_criteria: Users removed from the stage (e.g., churned, unsubscribed).
#    At least one per stage recommended. Can reuse the same segment across stages.
#
# ---
# CRITERIA CHECKLIST (verify before showing to client)
# ---
#
# [ ] Goal segment defined
# [ ] Stage 1 has entry_criteria segment
# [ ] Every non-last stage has a milestone segment (for next stage entry)
# [ ] Last stage has NO milestone
# [ ] Stage 2+ entry_criteria reuses previous stage's milestone (no new segment needed)
# [ ] Every stage has at least one exit_criteria (can reuse same embedded segment name)
#
# --- Segment Rule Reference ---
# Use `tdx sg fields` output to build rules. Common operators:
#
#   Equal             Exact match:     value: "true"
#   NotEqual          Not equal:       value: "inactive"
#   In                Multiple values: value: ["a", "b"]
#   GreaterEqual      Numeric:         value: 1000
#   LessEqual         Numeric:         value: 7
#   Between           Range:           min: 18, max: 65
#   TimeWithinPast    Recency:         value: 7, unit: day
#   IsNull            Null check:      (no value, use not: true for "is not null")
#   Contain           String contains: value: ["@gmail.com"]
#
# Behavior condition (requires source: behavior_<table_name>):
#   - type: Behavior
#     attribute: purchase_event
#     operator:
#       type: GreaterEqual
#       value: 1
#     aggregation:
#       type: Count                # Count | Sum | Average | Min | Max
#     source: behavior_purchases   # behavior_<table_name>
#     timeWindow:                  # Optional time restriction
#       duration: 30
#       unit: day
#
# --- If segment rules aren't working ---
# Load the **segment** skill for full operator reference, Behavior conditions,
# filter/timeWindow syntax, and nested condition groups.
#
# --- After designing the segments ---
#   1. Show the segment design to the client and get confirmation
#   2. Once confirmed, write the segments: section to the journey file
#   3. Immediately move to Step 2 — do NOT ask "shall we proceed?"
#
# ---
#
# Example: 3-stage journey criteria segments
#
# Milestone flow:
#   Stage 1 entry_criteria: new_signups (who enters Stage 1)
#   Stage 1 milestone:      email_engaged (who enters Stage 2)
#   Stage 2 milestone:      active_users (who enters Stage 3)
#   Stage 3:                no milestone (last stage)

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

segments:
  # -- Goal --
  onboarding_completed:
    description: User completed product setup
    rule:
      type: And
      conditions:
        - type: Value
          attribute: onboarding_status
          operator:
            type: Equal
            value: "completed"

  # -- Stage 1: Welcome & Engagement --
  # entry_criteria (Stage 1 ONLY — Stage 2+ use previous milestone)
  new_signups:
    description: Users who signed up in the last 7 days
    rule:
      type: And
      conditions:
        - type: Value
          attribute: signup_date
          operator:
            type: TimeWithinPast
            value: 7
            unit: day
  # milestone (defines who enters Stage 2)
  email_engaged:
    description: Users who opened welcome email — ready for Stage 2
    rule:
      type: And
      conditions:
        - type: Value
          attribute: email_opened
          operator:
            type: Equal
            value: "true"
  # exit_criteria
  churned_users:
    description: Users who churned (shared across all stages)
    rule:
      type: And
      conditions:
        - type: Value
          attribute: status
          operator:
            type: Equal
            value: "churned"

  # -- Stage 2: Product Activation --
  # entry_criteria: automatic (→ Stage 1 milestone: email_engaged)
  # milestone (defines who enters Stage 3)
  active_users:
    description: Users with 3+ logins in 7 days — ready for Stage 3
    rule:
      type: And
      conditions:
        - type: Value
          attribute: login_count_7d
          operator:
            type: GreaterEqual
            value: 3
  # exit_criteria: reuse churned_users (same embedded segment name in multiple stages)

  # -- Stage 3: Retention & Loyalty (last stage) --
  # entry_criteria: automatic (→ Stage 2 milestone: active_users)
  # milestone: NONE (last stage — no next stage to enter)
  # exit_criteria: reuse churned_users
