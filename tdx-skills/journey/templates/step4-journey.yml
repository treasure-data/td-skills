# ---
# Step 4: Journey Structure + Stage Steps
# ---
#
# Build the full journey: skeleton, goal, stage criteria, and steps.
# Segments (Steps 1-2) and activations (Step 3) are already defined.
#
# --- REQUIRED: Confirm with client before writing (do NOT skip) ---
# Ask the client for (if not already provided):
#   - Journey name and description
#   - Reentry mode: no_reentry | reentry_unless_goal_achieved | reentry_always
#   - Stage names, entry/exit criteria, milestones
#   - Flow for each stage (what steps, what order)
#
# Do NOT invent journey structure. ONLY reference segment/activation keys
# that already exist in YOUR segments: and activations: sections.
#
# --- Build steps ONE STAGE AT A TIME ---
#
# For each stage:
#   1. Sketch the flow as a comment (MANDATORY — see format below)
#   2. Write steps following the flow
#   3. Run: tdx journey validate path/to/journey.yml
#   4. Show to client, get confirmation, then move to next stage
#
# --- FLOW CONTROL SUMMARY ---
#
# - Every branch MUST perform a different action (otherwise don't branch)
# - Multiple paths MUST converge through a Merge step (not directly to End)
# - No Merge → Merge chains; wait required after activation (via merge is OK)
# - End step: no next, no with
# - Condition wait: if both paths do the same thing, use duration wait instead
#
# See validate-journey skill for full flow control rules and Design Rules.
#
# --- FLOW SKETCH FORMAT (MANDATORY before writing steps) ---
#
#   # Flow: [First Step] → [Second Step] → Decision([Branch Names])
#   #       [Branch A] → [Activation] → Merge → Wait → End
#   #       [Branch B] → [Activation] → Merge
#
# --- Wait + Jump ---
#
#   Duration: with: { duration: 3, unit: day }
#   wait_until: "2025-04-01" | days_of_week: ["monday","friday"] (see SKILL.md)
#
#   Condition (NO top-level next: — paths are inside condition):
#     with:
#       condition:
#         segment: made-purchase
#         next: follow-up
#         timeout: { duration: 14, unit: day, next: timeout-path }
#
#   Jump (routes users to another journey — NO next: field):
#   - type: jump
#     name: Jump to Nurture
#     with:
#       target: { journey: Nurture Journey, stage: Follow Up }
#   Jump does NOT need a wait before it. If one branch jumps and another
#   continues, the continuing branch still needs Merge → Wait → End.
#
# --- After designing each stage ---
#   1. Show the stage design to the client and get confirmation
#   2. Write the updated YAML and immediately move to the next stage
#   3. After ALL stages are done, proceed to Step 5 (validate)
#
# ---
# FULL EXAMPLE: Pattern A (Simple branch with Merge)
#
# Flow: Activation → Wait → Decision(Opened/Not Opened)
#       Opened → Follow Up → Merge → Wait 1 Day → End
#       Not Opened → SMS → Merge
# ---

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

segments:
  # (from Steps 1-2 — do not modify)

activations:
  # (from Step 3 — do not modify)

goal:
  name: Onboarding Complete
  segment: onboarding_completed

journeys:
  - state: draft
    stages:
      # ---
      # Pattern A: Simple branch with Merge
      # Flow: Email → Wait → Decision(Opened/Not Opened)
      #       Opened → Follow Up Email → Merge → Wait 1 Day → End
      #       Not Opened → SMS → Merge
      # ---
      - name: "Stage 1: Welcome & Engagement"
        entry_criteria:
          name: New Signups
          segment: new_signups
        milestone:
          name: Email Engaged
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps:
          - type: activation
            name: Send Welcome Email
            next: Wait 3 Days
            with:
              activation: welcome-email

          - type: wait
            name: Wait 3 Days
            next: Email Open Check
            with:
              duration: 3
              unit: day

          - type: decision_point
            name: Email Open Check
            with:
              branches:
                - name: Opened
                  segment: email_engaged
                  next: Send Follow Up
                - name: Not Opened
                  excluded: true
                  next: Send SMS Reminder

          - type: activation
            name: Send Follow Up
            next: Merge Welcome
            with:
              activation: follow-up-email

          - type: activation
            name: Send SMS Reminder
            next: Merge Welcome
            with:
              activation: sms-reminder

          - type: merge
            name: Merge Welcome
            next: Wait After Welcome

          - type: wait
            name: Wait After Welcome
            next: End Stage 1
            with:
              duration: 1
              unit: day

          - type: end
            name: End Stage 1

      # ---
      # Pattern B: 3-way branch with longer path on one branch
      # Flow: Wait → Decision(Power User/Active/Inactive)
      #       Power User → Upsell → Merge → Wait 1 Day → End
      #       Active → Tips → Merge
      #       Inactive → Push → Wait → Tips → Merge
      # ---
      - name: "Stage 2: Product Activation"
        entry_criteria:
          name: Engaged Users
          segment: email_engaged
        milestone:
          name: Active Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps: []
        # Build steps following the flow sketch above.
        # Use Stage 1 as the reference for step YAML syntax.

      # ---
      # Pattern C: Linear + decision
      # Flow: Wait → Survey → Wait → Decision(Promoter/Detractor/Passive)
      #       Promoter → Referral → Merge → Wait 1 Day → End
      #       Detractor → Support Call → Merge
      #       Passive → Thank You → Merge
      # ---
      - name: "Stage 3: Retention & Loyalty"
        entry_criteria:
          name: Activated Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps: []
        # Build steps following the flow sketch above.

# --- Additional Patterns ---
#
# A/B Test:
#   Flow: Wait → A/B Test(A 50%/B 50%) → [Email A / Email B] → Merge → Wait → End
#   - type: ab_test
#     name: Message Test
#     with:
#       variants:
#         - name: Casual Tone
#           percentage: 50
#           next: Send Casual Email
#         - name: Professional Tone
#           percentage: 50
#           next: Send Pro Email
#
# Condition Wait:
#   Flow: Offer → Wait(Met→Thank You / Timeout→Discount) → Merge → Wait → End
#   Each path MUST lead to a DIFFERENT action (otherwise use duration wait).
