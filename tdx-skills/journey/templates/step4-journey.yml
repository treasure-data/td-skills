# =============================================================================
# Step 4: Journey Structure + Stage Steps
# =============================================================================
#
# Build the full journey: skeleton, goal, stage criteria, and steps.
# Segments (Steps 1-2) and activations (Step 3) are already defined.
#
# --- REQUIRED: Confirm with client before writing (do NOT skip) ---
# Ask the client for (if not already provided):
#   - Journey name and description
#   - Reentry mode:
#       no_reentry                    — users enter once only
#       reentry_unless_goal_achieved  — re-enter if goal not yet met
#       reentry_always                — always allow re-entry
#   - Stage names, entry/exit criteria, milestones
#   - Flow for each stage (what steps, what order)
#
# Do NOT invent journey structure. Use segments from Steps 1-2 and
# activations from Step 3 — only reference keys that already exist.
#
# Segments and activations: ONLY reference keys defined in YOUR segments:
# and activations: sections, or use ref: for journey-type segments from
# other journeys (see SKILL.md for ref: limitations).
#
# --- Build steps ONE STAGE AT A TIME ---
# Do not write all stages at once.
#
# For each stage:
#   1. Sketch the flow as a comment (MANDATORY — see format below)
#   2. Write steps following the flow
#   3. Run the flow validation checklist (MANDATORY — see below)
#   4. Write the updated YAML, show to client, get confirmation
#   5. Then move to the next stage
#
# =============================================================================
# FLOW CONTROL RULES (CRITICAL)
# =============================================================================
#
# Rule 1: Every branch MUST perform a different action. A branch that merges
#   without doing anything is pointless — if branches do the same thing,
#   there is no reason to branch.
#   This applies to ALL branching types: decision_point, condition wait, ab_test.
#
#   decision_point / ab_test:
#     GOOD: Branch A → Activation X → Merge
#           Branch B → Activation Y → Merge
#     BAD:  Branch A → Merge                  ← No action in branch
#     BAD:  Branch A → Activation X → Merge
#           Branch B → Activation X → Merge   ← Same action, no point branching
#
#   condition wait:
#     GOOD: Matched → Activation X → Merge    ← Different actions per path
#           Timeout → Activation Y → Merge
#     BAD:  Matched → Merge                   ← Both paths do nothing different
#           Timeout → Merge
#     If both paths lead to the same place with no different actions,
#     use a simple duration wait instead of a condition wait.
#
# Rule 2: Multiple paths MUST converge through a Merge step.
#   GOOD: Branch A → Activation → Merge → End
#         Branch B → Activation → Merge
#   BAD:  Branch A → Activation → End       ← Two paths to same End
#         Branch B → Activation → End
#
# Rule 3: Do NOT chain Merge → Merge.
#   GOOD: Merge → Wait → End
#   BAD:  Merge → Merge → End              ← Invalid chain
#
# Rule 3b: Nested branching (branch inside a branch):
#   Inner branches MUST merge before joining the outer branch.
#   GOOD: Decision A → [Branch A1 → inner Decision → inner Merge → Merge A]
#   BAD:  Decision A → [Branch A1 → inner Decision → Merge A]  ← inner paths not merged
#   Note: Nested branching increases complexity. Prefer flat patterns when possible.
#
# Rule 4: Always insert a wait step after an activation step.
#   GOOD: Activation → Wait → next step
#   GOOD: Activation → Merge → Wait → End   (wait after merge is OK)
#   BAD:  Activation → Activation            ← No wait between
#
# Rule 5: Single-input Merge is unnecessary.
#   If only one path leads to a Merge, remove it and go directly to next step.
#
# Rule 6: End step must have NO next and NO with.
#
# =============================================================================
# FLOW VALIDATION CHECKLIST (run for EACH stage before writing)
# =============================================================================
#
# After sketching the flow, verify ALL of the following:
#
# [ ] Every branch (decision_point, ab_test, condition wait) performs a different action
# [ ] No branch goes directly to merge without an activation
# [ ] Condition wait paths lead to different actions (otherwise use duration wait)
# [ ] All branching paths converge through a Merge step (not directly to End)
# [ ] No Merge → Merge chains exist
# [ ] Every activation is followed by a wait (or merge then wait)
# [ ] Every non-branching, non-end step has an explicit next: field
# [ ] Every next: reference points to a valid step name in THIS stage
# [ ] Stage has exactly one End step with no next/with
# [ ] No orphaned steps (every step is reachable from the first step)
#
# =============================================================================
# FLOW SKETCH FORMAT (MANDATORY before writing steps)
# =============================================================================
#
# Use this format — list every step, show branches with indentation:
#
#   # Flow: [First Step] → [Second Step] → Decision([Branch Names])
#   #       [Branch A] → [Activation] → Merge → Wait → End
#   #       [Branch B] → [Activation] → Merge
#
# =============================================================================
# STEP TYPES QUICK REFERENCE
# =============================================================================
#
#   | Type           | with Parameters                          |
#   |----------------|------------------------------------------|
#   | wait           | duration + unit, or condition, or wait_until |
#   | activation     | activation (key from activations section) |
#   | decision_point | branches[] with segment, next             |
#   | ab_test        | variants[] with percentage, next          |
#   | merge          | (none)                                    |
#   | jump           | target with journey, stage                |
#   | end            | (none) — no next or with allowed          |
#
# --- Wait Step Types ---
#   Duration (fixed time delay):
#   - type: wait
#     name: Wait 3 Days
#     next: Next Step
#     with:
#       duration: 3
#       unit: day
#
#   Additional duration options:
#   - type: wait
#     name: Wait Until Launch
#     next: Next Step
#     with:
#       wait_until: "2025-04-01"       # Wait until specific date
#
#   - type: wait
#     name: Wait for Weekday
#     next: Next Step
#     with:
#       duration: 7
#       unit: day
#       days_of_week: ["monday", "wednesday", "friday"]
#
#   Condition (wait for user action):
#   NOTE: Condition wait has NO top-level next: (paths are inside condition)
#   - type: wait
#     name: Wait for Purchase
#     with:
#       condition:
#         segment: made-purchase     # Segment from Step 2
#         next: follow-up            # Path when matched
#         timeout:                   # Max wait duration
#           duration: 14
#           unit: day
#           next: timeout-path       # Path when timed out
#
# --- Jump Step ---
#   Jump routes users to another journey/stage. It has NO next: field.
#   - type: jump
#     name: Jump to Nurture
#     with:
#       target:
#         journey: Nurture Journey
#         stage: Follow Up
#
#   Flow rules for jump:
#   - Jump has no next: (users leave this journey)
#   - If one branch jumps and another continues, the continuing branch
#     still needs Merge → Wait → End as usual
#   - Jump does NOT need a wait before it
#
# --- After updating the YAML ---
#   1. Write full journey structure with first stage's steps
#   2. Write the updated YAML to the journey file
#   3. Show the stage design to the client and get confirmation.
#      Once confirmed, write the YAML and immediately move to the next stage.
#      Do NOT ask "shall we proceed?" after writing — confirmation was already given.
#   4. Repeat for each remaining stage
#   5. After ALL stages are done, proceed to Step 5 (validate)
#
# =============================================================================
# EXAMPLE PATTERNS
# =============================================================================
#
# Below are common stage patterns. Use these as reference when building.
# Pattern A: Simple branch (decision_point)
# Pattern B: 3-way branch (decision_point)
# Pattern C: Linear flow with decision
# A/B Test Pattern (commented)
# Condition Wait Pattern (commented) — MUST have different actions per path
# Linear Pattern (commented) — no branching, simple sequential flow
# Escalation Pattern (commented) — chained condition waits for progressive messaging

# =============================================================================
# Pattern A: Simple branch with Merge
#
# IMPORTANT: Each branch MUST lead to a DIFFERENT activation.
# A branch that goes directly to Merge or End without an action is pointless.
# If all branches do the same thing, remove the decision_point entirely.
#
# Flow: Activation → Wait → Decision(Opened/Not Opened)
#       Opened → Follow Up → Merge → End
#       Not Opened → SMS → Merge
# =============================================================================

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

segments:
  # (from Steps 1-2 — do not modify)

activations:
  # (from Step 3 — do not modify)

goal:
  name: Onboarding Complete
  segment: onboarding_completed

journeys:
  - state: draft
    stages:
      # ================================================================
      # Pattern A: Simple branch with Merge
      # Flow: Email → Wait → Decision(Opened/Not Opened)
      #       Opened → Follow Up Email → Merge → Wait 1 Day → End
      #       Not Opened → SMS → Merge
      # ================================================================
      - name: "Stage 1: Welcome & Engagement"
        entry_criteria:
          name: New Signups
          segment: new_signups
        milestone:
          name: Email Engaged
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps:
          - type: activation
            name: Send Welcome Email
            next: Wait 3 Days
            with:
              activation: welcome-email

          - type: wait
            name: Wait 3 Days
            next: Email Open Check
            with:
              duration: 3
              unit: day

          - type: decision_point
            name: Email Open Check
            with:
              branches:
                - name: Opened
                  segment: email_engaged
                  next: Send Follow Up
                - name: Not Opened
                  excluded: true
                  next: Send SMS Reminder

          - type: activation
            name: Send Follow Up
            next: Merge Welcome
            with:
              activation: follow-up-email

          - type: activation
            name: Send SMS Reminder
            next: Merge Welcome
            with:
              activation: sms-reminder

          - type: merge
            name: Merge Welcome
            next: Wait After Welcome

          - type: wait
            name: Wait After Welcome
            next: End Stage 1
            with:
              duration: 1
              unit: day

          - type: end
            name: End Stage 1

      # ================================================================
      # Pattern B: 3-way branch with longer path on one branch
      # Flow: Wait → Decision(Power User/Active/Inactive)
      #       Power User → Upsell → Merge → Wait 1 Day → End
      #       Active → Tips → Merge
      #       Inactive → Push → Wait → Tips → Merge
      # ================================================================
      - name: "Stage 2: Product Activation"
        entry_criteria:
          name: Engaged Users
          segment: email_engaged
        milestone:
          name: Active Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps:
          - type: wait
            name: Wait 1 Day
            next: Usage Level Check
            with:
              duration: 1
              unit: day

          - type: decision_point
            name: Usage Level Check
            with:
              branches:
                - name: Power User
                  segment: power_users
                  next: Send Upsell Offer
                - name: Active
                  segment: active_users
                  next: Send Feature Tips
                - name: Inactive
                  excluded: true
                  next: Reengagement Push

          - type: activation
            name: Send Upsell Offer
            next: Merge Activation
            with:
              activation: upsell-email

          - type: activation
            name: Send Feature Tips
            next: Merge Activation
            with:
              activation: feature-tips-email

          - type: activation
            name: Reengagement Push
            next: Wait 2 Days
            with:
              activation: reengage-push

          - type: wait
            name: Wait 2 Days
            next: Send Reminder Tips
            with:
              duration: 2
              unit: day

          - type: activation
            name: Send Reminder Tips
            next: Merge Activation
            with:
              activation: feature-tips-email

          - type: merge
            name: Merge Activation
            next: Wait After Activation

          - type: wait
            name: Wait After Activation
            next: End Stage 2
            with:
              duration: 1
              unit: day

          - type: end
            name: End Stage 2

      # ================================================================
      # Pattern C: Linear flow with decision (no branching merge needed)
      # Flow: Wait → Survey → Wait → Decision(Promoter/Detractor/Passive)
      #       Promoter → Referral → Merge → Wait 1 Day → End
      #       Detractor → Support Call → Merge
      #       Passive → Thank You → Merge
      # ================================================================
      - name: "Stage 3: Retention & Loyalty"
        entry_criteria:
          name: Activated Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: churned_users
        steps:
          - type: wait
            name: Wait 7 Days
            next: Send NPS Survey
            with:
              duration: 7
              unit: day

          - type: activation
            name: Send NPS Survey
            next: Wait for Response
            with:
              activation: nps-survey-email

          - type: wait
            name: Wait for Response
            next: NPS Score Check
            with:
              duration: 3
              unit: day

          - type: decision_point
            name: NPS Score Check
            with:
              branches:
                - name: Promoter
                  segment: nps_promoters
                  next: Send Referral Invite
                - name: Detractor
                  segment: nps_detractors
                  next: Schedule Support Call
                - name: Passive
                  excluded: true
                  next: Send Thank You

          - type: activation
            name: Send Referral Invite
            next: Merge Retention
            with:
              activation: referral-invite-email

          - type: activation
            name: Schedule Support Call
            next: Merge Retention
            with:
              activation: support-call

          - type: activation
            name: Send Thank You
            next: Merge Retention
            with:
              activation: thankyou-email

          - type: merge
            name: Merge Retention
            next: Wait After Retention

          - type: wait
            name: Wait After Retention
            next: End Stage 3
            with:
              duration: 1
              unit: day

          - type: end
            name: End Stage 3

# =============================================================================
# A/B Test Pattern (use when client wants to test variants)
# =============================================================================
#
# IMPORTANT: Each variant MUST lead to a DIFFERENT activation.
# If all variants send the same content, there is nothing to test.
# A variant that goes directly to Merge or End without an action is pointless.
#
# Flow: Wait → A/B Test(Variant A 50% / Variant B 50%)
#       Variant A → Email A → Merge → Wait → End
#       Variant B → Email B → Merge
#
# steps:
#   - type: wait
#     name: Wait 1 Day
#     next: Message Test
#     with:
#       duration: 1
#       unit: day
#
#   - type: ab_test
#     name: Message Test
#     with:
#       variants:
#         - name: Casual Tone
#           percentage: 50
#           next: Send Casual Email
#         - name: Professional Tone
#           percentage: 50
#           next: Send Pro Email
#
#   - type: activation
#     name: Send Casual Email
#     next: Merge Test
#     with:
#       activation: casual-email
#
#   - type: activation
#     name: Send Pro Email
#     next: Merge Test
#     with:
#       activation: pro-email
#
#   - type: merge
#     name: Merge Test
#     next: Wait After Test
#
#   - type: wait
#     name: Wait After Test
#     next: End Stage
#     with:
#       duration: 3
#       unit: day
#
#   - type: end
#     name: End Stage

# =============================================================================
# Condition Wait Pattern (use when waiting for a user action with timeout)
# =============================================================================
#
# IMPORTANT: Each path (met / timeout) MUST lead to a DIFFERENT action.
# If both paths do the same thing or both go straight to End/Merge,
# the condition wait is pointless — use a simple duration wait instead.
#
# Flow: Offer Email → Wait for Purchase(Met/Timeout)
#       Met → Thank You Email → Merge → Wait 1 Day → End
#       Timeout → Discount Coupon → Merge
#
# steps:
#   - type: activation
#     name: Send Offer Email
#     next: Wait for Purchase
#     with:
#       activation: offer-email
#
#   - type: wait
#     name: Wait for Purchase
#     with:
#       condition:
#         segment: made_purchase
#         next: Send Thank You
#         timeout:
#           duration: 7
#           unit: day
#           next: Send Discount Coupon
#
#   - type: activation
#     name: Send Thank You
#     next: Merge Purchase
#     with:
#       activation: thankyou-email
#
#   - type: activation
#     name: Send Discount Coupon
#     next: Merge Purchase
#     with:
#       activation: discount-email
#
#   - type: merge
#     name: Merge Purchase
#     next: Wait After Purchase
#
#   - type: wait
#     name: Wait After Purchase
#     next: End Stage
#     with:
#       duration: 1
#       unit: day
#
#   - type: end
#     name: End Stage

# =============================================================================
# Linear Pattern (no branching — use for simple sequential stages)
# =============================================================================
#
# Flow: Activation → Wait → Activation → Wait → End
#
# steps:
#   - type: activation
#     name: Send Recommendation
#     next: Wait 3 Days
#     with:
#       activation: recommendation-email
#
#   - type: wait
#     name: Wait 3 Days
#     next: Send Follow Up
#     with:
#       duration: 3
#       unit: day
#
#   - type: activation
#     name: Send Follow Up
#     next: Wait 1 Day
#     with:
#       activation: follow-up-email
#
#   - type: wait
#     name: Wait 1 Day
#     next: End Stage
#     with:
#       duration: 1
#       unit: day
#
#   - type: end
#     name: End Stage

# =============================================================================
# Escalation Pattern (chained condition waits for progressive messaging)
# =============================================================================
#
# For "reminder → stronger reminder → final offer" flows, chain
# condition waits sequentially:
#
# Flow: Offer Email → Wait for Purchase(Met/Timeout)
#       Met → Thank You → Merge → Wait → End
#       Timeout → Discount 10% → Wait for Purchase 2(Met/Timeout)
#                 Met → Thank You → Merge
#                 Timeout → Discount 20% → Merge
