# Complete Journey Example
# Multi-stage retention campaign with all features
# File location: ./segments/(parent-segment-name)/retention-journey.yml

type: journey
name: Customer Retention Journey
description: Multi-stage retention campaign

goal:
  name: Made Purchase
  segment: ref:Purchasers  # External segment reference (use ref: prefix)
  target:  # Optional: jump when goal met
    journey: Post-Purchase Journey
    stage: Thank You

reentry: reentry_unless_goal_achieved

# Embedded segments (journey-local)
# These are defined within the journey and referenced by key name
segments:
  engaged-users:
    description: Users who opened email
    rule:
      type: And
      conditions:
        - type: Value
          attribute: email_opened
          operator:
            type: Equal
            value: "true"
  new-customers:
    description: Customers in last 30 days
    rule:
      type: And
      conditions:
        - type: Value
          attribute: created_at
          operator:
            type: TimeWithinPast
            value: 30
            unit: day

# Embedded activations (journey-local)
# Use `tdx connection list` to find connection names
# Use `tdx connection schema <connection-type>` to discover connector_config fields
# Example: `tdx connection schema salesforce_marketing_cloud_v2`
activations:
  discount-email:
    name: Discount Offer Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: DiscountOffers
      shared_data_extension: false
      data_operation: upsert
  reminder-email:
    name: Send Reminder Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: ReminderEmails
      shared_data_extension: false
      data_operation: upsert
  trial-email:
    name: Free Trial Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: TrialOffers
      shared_data_extension: false
      data_operation: upsert
  welcome-email:
    name: Send Welcome Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: WelcomeEmails
      shared_data_extension: false
      data_operation: upsert

# Journey versions
journeys:
  - state: draft  # Push as draft, validate with simulation before launching
    stages:
      # Stage 1: Welcome Stage
      - name: Welcome Stage
        description: Initial customer engagement
        entry_criteria:
          name: New Customers
          segment: new-customers  # References embedded segment
        exit_criteria:
          - name: Churned
            segment: ref:Churned Users  # External segment (ref: prefix)
        milestone:
          name: Email Opened
          segment: engaged-users
        steps:
          # Wait step - duration-based
          - type: wait
            name: Wait 1 Day
            with:
              duration: 1
              unit: day

          # Activation step - send to external system
          - type: activation
            name: Send Welcome
            with:
              activation: welcome-email

          # Decision point - branch based on segment
          - type: decision_point
            name: check-engagement
            with:
              branches:
                - name: Engaged
                  segment: engaged-users
                  next: premium-path
                - name: Not Engaged
                  segment: ref:Non-Engaged
                  excluded: true  # Else/default branch
                  next: reminder-path

          # Branch A: Premium path
          - type: wait
            name: premium-path
            with:
              duration: 3
              unit: day

          # Branch B: Reminder path
          - type: activation
            name: reminder-path
            with:
              activation: reminder-email

          # Merge - rejoin branched paths
          - type: merge
            name: Rejoin Paths

          # End step - terminate stage
          - type: end
            name: final-check

      # Stage 2: Conversion Stage
      - name: Conversion Stage
        entry_criteria:
          name: Engaged Users
          segment: engaged-users
        steps:
          # A/B test - split traffic
          - type: ab_test
            name: Test Offers
            with:
              customized_split: true  # Manual percentages (false = equal)
              unique_id: offer_test_001  # Optional
              variants:
                - name: Discount Offer
                  percentage: 50
                  next: discount-path
                - name: Free Trial
                  percentage: 50
                  next: trial-path

          - type: activation
            name: discount-path
            with:
              activation: discount-email

          - type: activation
            name: trial-path
            with:
              activation: trial-email

          # Jump - route to another journey
          - type: jump
            name: Jump to Nurture
            with:
              target:
                journey: Nurture Journey
                stage: Follow Up

          - type: end
            name: Stage Complete
