# Complete Journey Example
# Multi-stage onboarding campaign demonstrating all features
# File location: ./segments/(parent-segment-name)/onboarding-journey.yml
#
# This example uses:
#   - Stage 1: decision_point pattern (non-last stage with milestone)
#   - Stage 2: ab_test pattern (last stage, no milestone)
#   - All flow control rules applied (Merge → Wait → End)
#   - Every non-branching, non-end step has explicit next:

type: journey
name: Customer Onboarding Journey
description: 2-stage onboarding with engagement check and offer testing

goal:
  name: Made Purchase
  segment: purchasers
  # target:                    # Optional: jump when goal met
  #   journey: Post-Purchase Journey
  #   stage: Thank You

reentry: reentry_unless_goal_achieved

# Embedded segments (journey-local)
segments:
  purchasers:
    description: Users who made a purchase
    rule:
      type: And
      conditions:
        - type: Value
          attribute: purchase_status
          operator:
            type: Equal
            value: "completed"
  new-customers:
    description: Customers who signed up in last 7 days
    rule:
      type: And
      conditions:
        - type: Value
          attribute: signup_date
          operator:
            type: TimeWithinPast
            value: 7
            unit: day
  follow-up-engaged:
    description: Users who opened welcome email — ready for Stage 2
    rule:
      type: And
      conditions:
        - type: Value
          attribute: email_opened
          operator:
            type: Equal
            value: "true"
  churned-users:
    description: Users who churned
    rule:
      type: And
      conditions:
        - type: Value
          attribute: status
          operator:
            type: Equal
            value: "churned"

# Embedded activations (journey-local)
# Use `tdx connection list` to find connection names
# Use `tdx connection schema <connection-type>` to discover connector_config fields
activations:
  welcome-email:
    name: Send Welcome Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: WelcomeEmails
      shared_data_extension: false
      data_operation: upsert
  follow-up-email:
    name: Send Follow Up Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: FollowUpEmails
      shared_data_extension: false
      data_operation: upsert
  reminder-email:
    name: Send SMS Reminder
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: ReminderEmails
      shared_data_extension: false
      data_operation: upsert
  discount-email:
    name: Discount Offer Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: DiscountOffers
      shared_data_extension: false
      data_operation: upsert
  trial-email:
    name: Free Trial Email
    connection: My SFMC Connection
    all_columns: true
    schedule:
      type: none
      timezone: UTC
    connector_config:
      de_name: TrialOffers
      shared_data_extension: false
      data_operation: upsert

# Journey versions
journeys:
  - state: draft
    stages:
      # ================================================================
      # Stage 1: Welcome & Engagement (decision_point pattern)
      # Flow: Send Welcome → Wait 3 Days → Decision(Opened/Not Opened)
      #       Opened → Send Follow Up → Merge → Wait 1 Day → End
      #       Not Opened → Send SMS Reminder → Merge
      # ================================================================
      - name: "Welcome & Engagement"
        description: Initial customer engagement with email open check
        entry_criteria:
          name: New Customers
          segment: new-customers
        milestone:
          name: Email Engaged
          segment: follow-up-engaged
        exit_criteria:
          - name: Churned
            segment: churned-users
        steps:
          - type: activation
            name: Send Welcome
            next: Wait 3 Days
            with:
              activation: welcome-email

          - type: wait
            name: Wait 3 Days
            next: Check Engagement
            with:
              duration: 3
              unit: day
              # wait_until: "2025-04-01"       # Alternative: wait until date
              # days_of_week: ["monday"]        # Alternative: wait for weekday

          - type: decision_point
            name: Check Engagement
            with:
              branches:
                - name: Opened
                  segment: follow-up-engaged
                  next: Send Follow Up
                - name: Not Opened
                  excluded: true
                  next: Send SMS Reminder

          - type: activation
            name: Send Follow Up
            next: Merge Welcome
            with:
              activation: follow-up-email

          - type: activation
            name: Send SMS Reminder
            next: Merge Welcome
            with:
              activation: reminder-email

          - type: merge
            name: Merge Welcome
            next: Wait After Welcome

          - type: wait
            name: Wait After Welcome
            next: End Stage 1
            with:
              duration: 1
              unit: day

          - type: end
            name: End Stage 1

      # ================================================================
      # Stage 2: Conversion (ab_test pattern — last stage, no milestone)
      # Flow: Wait 1 Day → A/B Test(Discount 50% / Trial 50%)
      #       Discount → Send Discount → Merge → Wait 3 Days → End
      #       Trial → Send Trial → Merge
      # ================================================================
      - name: "Conversion"
        description: Test discount vs trial offers
        entry_criteria:
          name: Email Engaged
          segment: follow-up-engaged
        # No milestone — this is the last stage
        exit_criteria:
          - name: Churned
            segment: churned-users
        steps:
          - type: wait
            name: Wait 1 Day
            next: Test Offers
            with:
              duration: 1
              unit: day

          - type: ab_test
            name: Test Offers
            with:
              customized_split: true
              unique_id: onboarding_offer_test
              variants:
                - name: Discount Offer
                  percentage: 50
                  next: Send Discount Offer
                - name: Free Trial
                  percentage: 50
                  next: Send Trial Offer

          - type: activation
            name: Send Discount Offer
            next: Merge Offers
            with:
              activation: discount-email

          - type: activation
            name: Send Trial Offer
            next: Merge Offers
            with:
              activation: trial-email

          - type: merge
            name: Merge Offers
            next: Wait After Test

          - type: wait
            name: Wait After Test
            next: End Stage 2
            with:
              duration: 3
              unit: day

          - type: end
            name: End Stage 2

          # --- Jump step example (commented out) ---
          # If you need to route users to another journey instead of ending:
          #
          # - type: jump
          #   name: Jump to Nurture
          #   with:
          #     target:
          #       journey: Nurture Journey
          #       stage: Follow Up

          # --- Condition wait example (commented out) ---
          # Use instead of duration wait when you want to react immediately:
          #
          # - type: wait
          #   name: Wait for Purchase
          #   with:
          #     condition:
          #       segment: purchasers
          #       next: Send Thank You
          #       timeout:
          #         duration: 7
          #         unit: day
          #         next: Send Reminder
