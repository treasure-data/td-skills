# =============================================================================
# Step 2: Goal and Stage Criteria (Segments)
# =============================================================================
#
# Build the segments: section, then wire up goal, entry_criteria, exit_criteria,
# and milestone for each stage.
#
# --- Segment Strategy ---
# Ask the client which approach to use:
#
# Option A: Create new embedded segments (recommended)
#   - Run `tdx sg fields` to discover available attributes and behaviors
#   - Define segments inline in the segments: section
#
# Option B: Reuse existing segments
#   - Run `tdx sg list` to discover existing child segments
#   - Run `tdx sg sql "Segment Name"` to inspect segment rules
#   - Reference with ref: prefix: segment: ref:Existing Segment
#   - Even with this approach, some segments will likely need to be embedded
#
# --- Segment Rule Reference ---
# Use `tdx sg fields` output to build rules. Common operators:
#
#   Equal             Exact match:     value: "true"
#   In                Multiple values: value: ["a", "b"]
#   GreaterEqual      Numeric:         value: 1000
#   LessEqual         Numeric:         value: 7
#   TimeWithinPast    Recency:         value: 7, unit: day
#   TimeBeforePast    Inactivity:      value: 30, unit: day
#   Contain           String contains: value: "@gmail.com"
#
# Behavior aggregation (requires source: behavior_<table_name>):
#   - type: Value
#     attribute: ""                # Empty for behavior count
#     operator:
#       type: GreaterEqual
#       value: 1
#     aggregation:
#       type: Count                # Count | Sum | Avg | Min | Max
#     source: behavior_purchases   # behavior_<table_name>
#
# --- Organization ---
# Organize segments: with comments showing usage and stage:
#   # -- Goal --
#   # -- Stage 1: Name --
#   # entry_criteria / milestone / exit_criteria
#
# --- After updating the YAML ---
#   1. Add segments: section with all criteria segments
#   2. Wire up goal, entry_criteria, exit_criteria, milestone in each stage
#   3. Write the updated YAML to the journey file
#   4. Interactive mode: Show the result and STOP. Do NOT ask "proceed?" â€” just wait.
#      Auto mode: Proceed directly to Step 3
#
# =============================================================================

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

# Embedded segments organized by usage and stage.
# ref: segments are noted as comments for visibility.
segments:
  # -- Goal --
  onboarding_completed:
    description: User completed product setup
    rule:
      type: And
      conditions:
        - type: Value
          attribute: onboarding_status
          operator:
            type: Equal
            value: "completed"

  # -- Stage 1: Welcome & Engagement --
  # entry_criteria
  new_signups:
    description: Users who signed up in the last 7 days
    rule:
      type: And
      conditions:
        - type: Value
          attribute: signup_date
          operator:
            type: TimeWithinPast
            value: 7
            unit: day
  # milestone
  email_engaged:
    description: Users who opened welcome email
    rule:
      type: And
      conditions:
        - type: Value
          attribute: email_opened
          operator:
            type: Equal
            value: "true"
  # exit_criteria (ref:Churned Users)

  # -- Stage 2: Product Activation --
  # entry_criteria (reuses: email_engaged)
  # exit_criteria (ref:Churned Users)

  # -- Stage 3: Retention & Loyalty --
  # entry_criteria
  active_users:
    description: Users with 3+ logins in 7 days
    rule:
      type: And
      conditions:
        - type: Value
          attribute: login_count_7d
          operator:
            type: GreaterEqual
            value: 3
  # exit_criteria (ref:Churned Users)

goal:
  name: Onboarding Complete
  segment: onboarding_completed

journeys:
  - state: draft
    latest: true
    stages:
      - name: "Stage 1: Welcome & Engagement"
        entry_criteria:
          name: New Signups
          segment: new_signups
        milestone:
          name: Email Engaged
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users

      - name: "Stage 2: Product Activation"
        entry_criteria:
          name: Engaged Users
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users

      - name: "Stage 3: Retention & Loyalty"
        entry_criteria:
          name: Activated Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users
