# =============================================================================
# Step 3: Journey Structure + Stage Steps
# =============================================================================
#
# Build the full journey: skeleton, goal, stage criteria, and steps.
# Segments (Step 1) and activations (Step 2) are already defined.
#
# --- Ask the client for ---
#   - Journey name and description
#   - Reentry mode:
#       no_reentry                    — users enter once only
#       reentry_unless_goal_achieved  — re-enter if goal not yet met
#       reentry_always                — always allow re-entry
#   - Stage names, entry/exit criteria, milestones
#
# --- Build steps ONE STAGE AT A TIME ---
# Do not write all stages at once.
#
# For each stage:
#   1. Sketch the flow as a comment before writing steps
#   2. Write steps following the flow
#   3. Verify all next: references point to valid step names within the stage
#   4. Write the updated YAML, show to client, get confirmation
#   5. Then move to the next stage
#
# --- Step Rules ---
#   next:        is a direct field on step, NOT inside with:
#   end:         no next or with allowed
#   merge:       rejoin all branches before end
#   activation:  with.activation references a key from activations: section
#   decision_point: branches reference segments from Step 1
#   ab_test:     variant percentages must sum to 100
#   wait:        duration + unit (day/week) or condition with optional timeout
#
# --- API Constraints (CRITICAL) ---
#   1. Every branch MUST have an activation step before merge.
#      A branch going directly to merge is invalid.
#      Good: Branch → Activation → Merge
#      Bad:  Branch → Merge
#   2. Always insert a wait step after an activation step.
#      If activation is immediately followed by merge, place wait AFTER the merge.
#      Good: Activation → Merge → Wait → End
#      Good: Activation → Wait → next step
#      Bad:  Activation → Activation (no wait between)
#
# --- Flow Sketch Pattern ---
#   # Flow: Wait → Email → Wait → Decision(Opened/Not Opened)
#   #       Opened → Follow Up → Merge → End
#   #       Not Opened → SMS → Merge → End
#
# --- Step Types Quick Reference ---
#   | Type           | with Parameters                          |
#   |----------------|------------------------------------------|
#   | wait           | duration + unit (day/week) or condition   |
#   | activation     | activation (key from activations section) |
#   | decision_point | branches[] with segment, next             |
#   | ab_test        | variants[] with percentage, next          |
#   | merge          | (none)                                    |
#   | jump           | target with journey, stage                |
#   | end            | (none) — no next or with allowed          |
#
# --- Wait Step Types ---
#   Duration (fixed time delay):
#   - type: wait
#     name: Wait 3 Days
#     next: Next Step
#     with:
#       duration: 3
#       unit: day
#
#   Condition (wait for user action):
#   - type: wait
#     name: Wait for Purchase
#     with:
#       condition:
#         segment: made-purchase     # Segment from Step 1
#         next: follow-up            # Path when matched
#         timeout:                   # Max wait duration
#           duration: 14
#           unit: day
#           next: timeout-path       # Path when timed out
#
# --- After updating the YAML ---
#   1. Write full journey structure with first stage's steps
#   2. Write the updated YAML to the journey file
#   3. Interactive mode: Show the result and STOP. Do NOT ask "proceed?" — just wait.
#      Auto mode: Proceed directly to the next stage
#   4. Repeat for each remaining stage
#   5. After ALL stages are done, proceed to Step 4 (validate)
#
# =============================================================================
#
# Below is the complete example with all stages filled in.
# When building for the client, do ONE STAGE AT A TIME.

type: journey
name: Welcome Onboarding Journey
description: 3-stage onboarding flow for new customers
reentry: no_reentry

segments:
  # (from Step 1 — do not modify)

activations:
  # (from Step 2 — do not modify)

goal:
  name: Onboarding Complete
  segment: onboarding_completed

journeys:
  - state: draft
    stages:
      # ================================================================
      # Stage 1: Welcome & Engagement
      # Flow: Email → Wait → Decision(Opened/Not Opened)
      #       Opened → Follow Up → Merge → End
      #       Not Opened → SMS → Merge → End
      # ================================================================
      - name: "Stage 1: Welcome & Engagement"
        entry_criteria:
          name: New Signups
          segment: new_signups
        milestone:
          name: Email Engaged
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users
        steps:
          - type: activation
            name: Send Welcome Email
            next: Wait 3 Days
            with:
              activation: welcome-email

          - type: wait
            name: Wait 3 Days
            next: Email Open Check
            with:
              duration: 3
              unit: day

          - type: decision_point
            name: Email Open Check
            with:
              branches:
                - name: Opened
                  segment: email_engaged
                  next: Send Follow Up
                - name: Not Opened
                  excluded: true
                  next: Send SMS Reminder

          - type: activation
            name: Send Follow Up
            next: Merge Welcome
            with:
              activation: welcome-email

          - type: activation
            name: Send SMS Reminder
            next: Merge Welcome
            with:
              activation: sms-reminder

          - type: merge
            name: Merge Welcome
            next: End Stage 1

          - type: end
            name: End Stage 1

      # ================================================================
      # Stage 2: Product Activation
      # Flow: Wait → Decision(Power User/Active/Inactive)
      #       Power User → Upsell → Merge → End
      #       Active → Tips → Merge → End
      #       Inactive → Push → Wait → Tips → Merge → End
      # ================================================================
      - name: "Stage 2: Product Activation"
        entry_criteria:
          name: Engaged Users
          segment: email_engaged
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users
        steps:
          - type: wait
            name: Wait 1 Day
            next: Usage Level Check
            with:
              duration: 1
              unit: day

          - type: decision_point
            name: Usage Level Check
            with:
              branches:
                - name: Power User
                  segment: power_users
                  next: Send Upsell Offer
                - name: Active
                  segment: active_users
                  next: Send Feature Tips
                - name: Inactive
                  excluded: true
                  next: Reengagement Push

          - type: activation
            name: Send Upsell Offer
            next: Merge Activation
            with:
              activation: upsell-email

          - type: activation
            name: Send Feature Tips
            next: Merge Activation
            with:
              activation: feature-tips-email

          - type: activation
            name: Reengagement Push
            next: Wait 2 Days
            with:
              activation: reengage-push

          - type: wait
            name: Wait 2 Days
            next: Send Reminder Tips
            with:
              duration: 2
              unit: day

          - type: activation
            name: Send Reminder Tips
            next: Merge Activation
            with:
              activation: feature-tips-email

          - type: merge
            name: Merge Activation
            next: End Stage 2

          - type: end
            name: End Stage 2

      # ================================================================
      # Stage 3: Retention & Loyalty
      # Flow: Wait → Survey → Wait → Decision(Promoter/Detractor/Passive)
      #       Promoter → Referral → Merge → End
      #       Detractor → Support Call → Merge → End
      #       Passive → Thank You → Merge → End
      # ================================================================
      - name: "Stage 3: Retention & Loyalty"
        entry_criteria:
          name: Activated Users
          segment: active_users
        exit_criteria:
          - name: Churned Users
            segment: ref:Churned Users
        steps:
          - type: wait
            name: Wait 7 Days
            next: Send NPS Survey
            with:
              duration: 7
              unit: day

          - type: activation
            name: Send NPS Survey
            next: Wait for Response
            with:
              activation: nps-survey-email

          - type: wait
            name: Wait for Response
            next: NPS Score Check
            with:
              duration: 3
              unit: day

          - type: decision_point
            name: NPS Score Check
            with:
              branches:
                - name: Promoter
                  segment: nps_promoters
                  next: Send Referral Invite
                - name: Detractor
                  segment: nps_detractors
                  next: Schedule Support Call
                - name: Passive
                  excluded: true
                  next: Send Thank You

          - type: activation
            name: Send Referral Invite
            next: Merge Retention
            with:
              activation: referral-invite-email

          - type: activation
            name: Schedule Support Call
            next: Merge Retention
            with:
              activation: support-call

          - type: activation
            name: Send Thank You
            next: Merge Retention
            with:
              activation: thankyou-email

          - type: merge
            name: Merge Retention
            next: End Stage 3

          - type: end
            name: End Stage 3
